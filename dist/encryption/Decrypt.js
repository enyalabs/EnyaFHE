var bignum=require("bignumber.js"),src=require("../src/src"),CRT=require("../math/CRT"),FHEMath=require("../math/FHEMath"),Encrypt=require("./Encrypt");bignum.config({ROUNDING_MODE:1});class Decrypt{Params(){for(var r=bignum("13537164"),e=src.plaintextModulus,s=bignum("1"),c=new Array(src.cycleorder/2),o=new Array(src.cycleorder/2),u=0;u<src.cycleorder/2;u++)c[u]=s,o[u]=s.times(bignum("2").pow(64)).idiv(e),s=s.times(r).mod(e);return[c,o]}InverseFormat(r,e,s){for(var[c,o]=CRT.rootOfUnityInverseTable(e,s),u=CRT.NTTForward(r,c,o,s),n=0;n<src.cycleorder/2;n++)u[n]=u[n].times(FHEMath.ModInverse(bignum((src.cycleorder/2).toString()),s)).mod(s);return u=CRT.ModMulPrecon(u,c,s,o)}ReadCiphertext(r){for(var e=new Array(src.modulus.length),s=new Array(src.modulus.length),c=0;c<src.modulus.length;c++){for(var o=new Array(src.cycleorder/2),u=new Array(src.cycleorder/2),n=0;n<src.cycleorder/2;n++)o[n]=bignum(r[c][n]),u[n]=bignum(r[c+3][n]);e[c]=o,s[c]=u}return e.push(...s),e}DecryptVector(r,e){e=FHEMath.vectortoBigNumber(e);for(var s=new Array(src.modulus.length),c=new Array(src.modulus.length),o=0;o<src.modulus.length;o++)s[o]=r[o],c[o]=r[o+3];var u=[];for(o=0;o<src.modulus.length;o++){for(var n=new Array(src.cycleorder/2),t=0;t<src.cycleorder/2;t++){var l=s[o][t].plus(e[o][t].times(c[o][t]).mod(src.modulus[o]));l.gt(src.modulus[o])&&(l=l.minus(src.modulus[o])),n[t]=l}u.push(this.InverseFormat(n,src.rootOfUnityInverse[o],src.modulus[o]))}var a=[];for(o=0;o<src.cycleorder/2;o++){var m=bignum("0"),i=bignum("0");for(t=0;t<src.modulus.length;t++){var d=u[t][o];m=m.plus(CRT.ModMulPrecon([d],[src.invTable[t]],src.plaintextModulus,[src.invPreconTable[t]])[0]),i=i.plus(d.times(src.numerator[t]).times(bignum("1000000000")).idiv(src.denominator[t]))}a.push(m.plus(i.idiv(bignum("1000000000"))).mod(src.plaintextModulus).plus(bignum("1")))}var[y,g]=this.Params(),v=CRT.ModMulPrecon(a,y,src.plaintextModulus,g),p=CRT.NTTForward(v,y,g,src.plaintextModulus),h=new Array(src.cycleorder/2),b=Encrypt.Params()[1];for(o=0;o<src.cycleorder/2;o++)h[o]=p[b[o]];for(o=0;o<p.length;o++)h[o]=h[o].toNumber();return h}}module.exports=new Decrypt;