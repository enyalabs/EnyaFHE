var bignum=require("bignumber.js"),nextFrame=require("next-frame"),FHEMath=require("../math/FHEMath"),src=require("../src/src"),CRT=require("../math/CRT");bignum.config({ROUNDING_MODE:1});class KeyGen{Format(r,t,e){var[a,n]=CRT.rootOfUnityForwardTable(t,e),o=CRT.ModMulPrecon(r,a,e,n);return CRT.NTTForward(o,a,n,e)}MultKey(r,t=src.modulus,e=src.rootOfUnity){r=FHEMath.vectortoBigNumber(r);for(var a=new Array(r.length),n=0;n<r.length;n++){for(var o=new Array(r[n].length),i=0;i<r[n].length;i++)o[i]=r[n][i].times(r[n][i]).mod(t[n]);a[n]=o}var[s,h]=this.KeySwitch(a,r,t,e);return s.push(...h),FHEMath.vectortoString(s)}async MultKeyRN(r,t=src.modulus,e=src.rootOfUnity){r=FHEMath.vectortoBigNumber(r);for(var a=new Array(r.length),n=0;n<r.length;n++){for(var o=new Array(r[n].length),i=0;i<r[n].length;i++)await nextFrame(),o[i]=r[n][i].times(r[n][i]).mod(t[n]);a[n]=o}var[s,h]=await this.KeySwitchRN(a,r,t,e);return s.push(...h),FHEMath.vectortoString(s)}RotaKey(r,t=[1],e=src.modulus,a=src.rootOfUnity){r=FHEMath.vectortoBigNumber(r);for(var n=new Array(t.length),o=0;o<t.length;o++)n[o]=CRT.FindRotationIndex(t[o],1024);var i=new Array(r.length*n.length);for(o=0;o<n.length;o++)for(var s=0;s<r.length;s++){for(var h=new Array(512).fill(0),u=1;u<1024;u+=2){var l=u*n[o]-(u*n[o]>>10<<10);h[u>>1]=r[s][l>>1]}i[o*s+s]=h}var[c,m]=this.KeySwitch(i,r,e,a);return c.push(...m),FHEMath.vectortoString(c)}async RotaKeyRN(r,t=[1],e=src.modulus,a=src.rootOfUnity){r=FHEMath.vectortoBigNumber(r);for(var n=new Array(t.length),o=0;o<t.length;o++)n[o]=CRT.FindRotationIndex(t[o],1024);var i=new Array(r.length*n.length);for(o=0;o<n.length;o++)for(var s=0;s<r.length;s++){await nextFrame();for(var h=new Array(512).fill(0),u=1;u<1024;u+=2){var l=u*n[o]-(u*n[o]>>10<<10);h[u>>1]=r[s][l>>1]}i[o*s+s]=h}var[c,m]=await this.KeySwitchRN(i,r,e,a);return c.push(...m),FHEMath.vectortoString(c)}KeySwitch(r,t,e,a){for(var n=[],o=[],i=0;i<t.length;i++)for(var s=FHEMath.DiscreteGaussian(e),h=0;h<t.length;h++){var u=FHEMath.DiscreteUniform(e[h]),l=this.Format(u,a[h],e[h]);o.push(l);for(var c=this.Format(s[h],a[h],e[h]),m=new Array(t[i].length),g=0;g<t[i].length;g++){var v=l[g].times(t[h][g]).mod(e[h]).plus(c[g]);v.gt(e[h])&&(v=v.minus(e[h])),i==h?((v=r[h][g].minus(v)).lte(bignum("0"))&&(v=v.plus(e[h])),m[g]=v):m[g]=e[h].minus(v)}n.push(m)}return[n,o]}async KeySwitchRN(r,t,e,a){for(var n=[],o=[],i=0;i<t.length;i++){var s=FHEMath.DiscreteGaussian(e);await nextFrame();for(var h=0;h<t.length;h++){var u=FHEMath.DiscreteUniform(e[h]),l=this.Format(u,a[h],e[h]);o.push(l);for(var c=this.Format(s[h],a[h],e[h]),m=new Array(t[i].length),g=0;g<t[i].length;g++){var v=l[g].times(t[h][g]).mod(e[h]).plus(c[g]);v.gt(e[h])&&(v=v.minus(e[h])),i==h?((v=r[h][g].minus(v)).lte(bignum("0"))&&(v=v.plus(e[h])),m[g]=v):m[g]=e[h].minus(v)}n.push(m)}}return[n,o]}PublicKey(r,t=src.rootOfUnity,e=src.modulus){r=FHEMath.vectortoBigNumber(r);for(var a=new Array(e.length),n=new Array(e.length),o=FHEMath.DiscreteGaussian(e),i=0;i<e.length;i++){var s=FHEMath.DiscreteUniform(e[i]);s=this.Format(s,t[i],e[i]),a[i]=s;for(var h=this.Format(o[i],t[i],e[i]),u=new Array(src.cycleorder/2),l=0;l<src.cycleorder/2;l++){var c=e[i].minus(h[l]);(c=c.minus(s[l].times(r[i][l]).mod(e[i]))).lt(bignum("0"))&&(c=c.plus(e[i])),u[l]=c}n[i]=u}return n.push(...a),FHEMath.vectortoString(n)}async PublicKeyRN(r,t=src.rootOfUnity,e=src.modulus){r=FHEMath.vectortoBigNumber(r);for(var a=new Array(e.length),n=new Array(e.length),o=FHEMath.DiscreteGaussian(e),i=0;i<e.length;i++){await nextFrame();var s=FHEMath.DiscreteUniform(e[i]);s=this.Format(s,t[i],e[i]),a[i]=s;for(var h=this.Format(o[i],t[i],e[i]),u=new Array(src.cycleorder/2),l=0;l<src.cycleorder/2;l++){var c=e[i].minus(h[l]);(c=c.minus(s[l].times(r[i][l]).mod(e[i]))).lt(bignum("0"))&&(c=c.plus(e[i])),u[l]=c}n[i]=u}return n.push(...a),FHEMath.vectortoString(n)}PrivateKey(r,t=src.rootOfUnity,e=src.modulus){for(var a=new Array(e.length),n=FHEMath.DiscreteBinary(e,r),o=0;o<e.length;o++){var i=this.Format(n[o],t[o],e[o]);a[o]=i}return FHEMath.vectortoString(a)}async PrivateKeyRN(r,t=src.rootOfUnity,e=src.modulus){for(var a=new Array(e.length),n=FHEMath.DiscreteBinary(e,r),o=0;o<e.length;o++){await nextFrame();var i=this.Format(n[o],t[o],e[o]);a[o]=i}return FHEMath.vectortoString(a)}}module.exports=new KeyGen;