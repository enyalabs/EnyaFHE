var bignum=require("bignumber.js"),FHEMath=require("../math/FHEMath"),src=require("../src/src"),KeyGen=require("./KeyGen"),CRT=require("../math/CRT");bignum.config({ROUNDING_MODE:1});class Encrypt{constructor(){this.m_initRoot=13537164}Params(r=src.cycleorder){for(var s=r>>1,t=r>>2,e=1,u=new Array(s).fill(0),o=new Array(s).fill(0),c=0;c<t;c++){u[(e-1)/2]=c,o[c]=(e-1)/2;var l=e*(r-1)%r;u[(l-1)/2]=c+t,o[c+t]=(l-1)/2,e=5*e%r}return[u,o]}VectorPacked(r){for(var s=this.Params()[0];r.length<src.cycleorder/2;)r.push(0);for(var t=new Array(src.cycleorder/2).fill(0),e=0;e<src.cycleorder/2;e++)t[e]=bignum(r[s[e]].toString());var u=this.SpecialCRT(t);return FHEMath.vectortoString(u)}SpecialCRT(r){for(var[s,t]=CRT.rootOfUnityInverseTable(FHEMath.ModInverse(bignum(this.m_initRoot.toString()),src.plaintextModulus),src.plaintextModulus),e=CRT.NTTForward(r,s,t,src.plaintextModulus),u=0;u<src.cycleorder/2;u++)e[u]=e[u].times(bignum("14238471297")).mod(src.plaintextModulus);return e=CRT.ModMulPrecon(e,s,src.plaintextModulus,t)}VectorEncrypt(r,s){r=FHEMath.vectortoBigNumber(r),s=FHEMath.vectortoBigNumber(s);for(var t=FHEMath.DiscreteGaussian(src.modulus),e=FHEMath.DiscreteGaussian(src.modulus),u=FHEMath.DiscreteBinary(src.modulus),o=[],c=[],l=[],i=[],n=0;n<src.modulus.length;n++)l.push(s[n]),i.push(s[n+3]);for(n=0;n<src.modulus.length;n++){for(var a=KeyGen.Format(r,src.rootOfUnity[n],src.modulus[n]),m=KeyGen.Format(u[n],src.rootOfUnity[n],src.modulus[n]),d=KeyGen.Format(t[n],src.rootOfUnity[n],src.modulus[n]),h=KeyGen.Format(e[n],src.rootOfUnity[n],src.modulus[n]),y=[],p=[],g=0;g<src.cycleorder/2;g++){var M=l[n][g].times(m[g]).mod(src.modulus[n]).plus(d[g]);M.gt(src.modulus[n])&&(M=M.minus(src.modulus[n])),(M=M.plus(a[g].times(src.deltaTable[n]).mod(src.modulus[n]))).gt(src.modulus[n])&&(M=M.minus(src.modulus[n])),y.push(M);var f=i[n][g].times(m[g]).mod(src.modulus[n]).plus(h[g]);f.gt(src.modulus[n])&&(f=f.minus(src.modulus[n])),p.push(f)}o.push(y),c.push(p)}for(n=0;n<c.length;n++)o.push(c[n]);return FHEMath.vectortoString(o)}}module.exports=new Encrypt;